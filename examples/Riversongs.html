<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <!-- polyfill -->
    <script src="../inc/shim/Base64.js" type="text/javascript"></script>
    <script src="../inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="../inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="../js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="../js/midi/gm.js" type="text/javascript"></script>
    <script src="../js/midi/loader.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="../js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script
      src="../js/util/dom_request_script.js"
      type="text/javascript"
    ></script>
  </head>

  <body>
    <script type="text/javascript">
      // Pitch to begin mapping sites to (48 = C3)
      const keyboardStart = 48;
      // Pitch to stop mapping sites to
      const keyboardEnd = 60;
      // Play actual song or modified song
      const playType = 'actual';
      // Mean site discharge values for 2018
      const annualValues = {
        '07374525': 3433,
        '07374000': 4142,
        '07289000': 3708,
        '07024175': 765,
        '07022000': 30520,
        '07010000': 57265,
        '07020500': 27872,
        '05587450': 30531,
        '05474500': 51286,
        '05420500': 53081,
        '05416100': 1096,
        '05411500': 2269,
        '05389500': 27468,
        '05288500': 31588,
        '05261000': 4854,
        '05242300': 11459
      };

      const usgsURL =
        'https://waterservices.usgs.gov/nwis/dv/?format=json&sites=07374525,07374000,07290880,07289000,07024175,07022000,07020500,07010000,05587450,05474500,05420500,05416100,05411500,05389500,05288500,05261000,05242300&siteType=ST&siteStatus=all';

      function httpGet(url) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open('GET', url, false);
        xmlHttp.send(null);
        return JSON.parse(xmlHttp.responseText);
      }

      // Allow actual or modified playing of MIDI notes
      function playMIDIStyle(note, type) {
        let midiNote;
        {
          type === 'actual'
            ? (midiNote = note)
            : (midiNote = modifiedMIDI[note]);
        }
        return midiNote;
      }

      const riverData = httpGet(usgsURL);

      // Clean up USGS JSON data
      const riverGauges = riverData.value.timeSeries
        .filter(
          site =>
            //Find only sites with discharge data
            site.variable.variableDescription ===
            'Discharge, cubic feet per second'
        )
        .map((site, index) => ({
          siteCode: site.sourceInfo.siteCode[0].value,
          name: site.sourceInfo.siteName,
          dischargeToday: site.values[0].value[0].value,
          midiActual: index + keyboardStart
        }));

      riverGauges.forEach(item => {
        if (Object.keys(annualValues).includes(item.siteCode)) {
          // Add annual discharge numbers to riverGauges
          item['dischargeAnnual'] = annualValues[item.siteCode];
        }
        // Normalize point data values to between 0-1
        let pointValue = item.dischargeToday / item.dischargeAnnual;
        {
          pointValue > 1
            ? (pointValue = 1 - 1 / pointValue / 2)
            : (pointValue = pointValue / 2);
        }
        item['pointValue'] = pointValue;
        // Add midi note values (actual and changed) to object
        let midiChanged;
        if (pointValue > 0.7) {
          item['midiChanged'] = item.midiActual + 1;
        } else if (pointValue < 0.3) {
          item['midiChanged'] = item.midiActual - 1;
        } else {
          item['midiChanged'] = item.midiActual;
        }
      });

      //Create object for MIDI value lookup
      let modifiedMIDI = {};
      riverGauges.forEach(
        site => (modifiedMIDI[site.midiActual] = site.midiChanged)
      );

      window.onload = function() {
        function touchStarted() {
          if (getAudioContext().state !== 'running') {
            getAudioContext().resume();
          }
        }
        MIDI.loadPlugin({
          soundfontUrl: './soundfont/',
          instrument: 'acoustic_grand_piano',
          onprogress: function(state, progress) {
            console.log(state, progress);
          },
          onsuccess: function() {
            var delay = 0; // play one note every quarter second
            var note = 48; // the MIDI note
            var velocity = 127; // how hard the note hits
            // play the note
            MIDI.setVolume(0, 127);

            // Hardcoded song: Row, row, row your boat
            // Row, row, row your boat
            MIDI.noteOn(0, playMIDIStyle(48, playType), 40, 0);
            MIDI.noteOff(0, playMIDIStyle(48, playType), 0.75);
            MIDI.noteOn(0, playMIDIStyle(48, playType), 40, 1);
            MIDI.noteOff(0, playMIDIStyle(48, playType), 1.75);
            MIDI.noteOn(0, playMIDIStyle(48, playType), 40, 2);
            MIDI.noteOff(0, playMIDIStyle(48, playType), 2.75);
            MIDI.noteOn(0, playMIDIStyle(50, playType), 40, 2.75);
            MIDI.noteOff(0, playMIDIStyle(50, playType), 2.9);
            MIDI.noteOn(0, playMIDIStyle(52, playType), 40, 3);
            MIDI.noteOff(0, playMIDIStyle(52, playType), 3.75);
            // Gently down the stream
            MIDI.noteOn(0, playMIDIStyle(52, playType), 40, 4);
            MIDI.noteOff(0, playMIDIStyle(52, playType), 4.75);
            MIDI.noteOn(0, playMIDIStyle(50, playType), 40, 4.75);
            MIDI.noteOff(0, playMIDIStyle(50, playType), 5);
            MIDI.noteOn(0, playMIDIStyle(52, playType), 40, 5);
            MIDI.noteOff(0, playMIDIStyle(52, playType), 5.5);
            MIDI.noteOn(0, playMIDIStyle(53, playType), 40, 5.75);
            MIDI.noteOff(0, playMIDIStyle(53, playType), 5.9);
            MIDI.noteOn(0, playMIDIStyle(55, playType), 40, 6);
            MIDI.noteOff(0, playMIDIStyle(55, playType), 7.5);
            // Merrily, merrily, merrily, merrily
            MIDI.noteOn(0, playMIDIStyle(60, playType), 40, 8);
            MIDI.noteOff(0, playMIDIStyle(60, playType), 8.33);
            MIDI.noteOn(0, playMIDIStyle(60, playType), 40, 8.33);
            MIDI.noteOff(0, playMIDIStyle(60, playType), 8.66);
            MIDI.noteOn(0, playMIDIStyle(60, playType), 40, 8.66);
            MIDI.noteOff(0, playMIDIStyle(60, playType), 8.99);

            MIDI.noteOn(0, playMIDIStyle(55, playType), 40, 9);
            MIDI.noteOff(0, playMIDIStyle(55, playType), 9.33);
            MIDI.noteOn(0, playMIDIStyle(55, playType), 40, 9.33);
            MIDI.noteOff(0, playMIDIStyle(55, playType), 9.66);
            MIDI.noteOn(0, playMIDIStyle(55, playType), 40, 9.66);
            MIDI.noteOff(0, playMIDIStyle(55, playType), 9.99);

            MIDI.noteOn(0, playMIDIStyle(52, playType), 40, 10);
            MIDI.noteOff(0, playMIDIStyle(52, playType), 10.33);
            MIDI.noteOn(0, playMIDIStyle(52, playType), 40, 10.33);
            MIDI.noteOff(0, playMIDIStyle(52, playType), 10.66);
            MIDI.noteOn(0, playMIDIStyle(52, playType), 40, 10.66);
            MIDI.noteOff(0, playMIDIStyle(52, playType), 10.99);

            MIDI.noteOn(0, playMIDIStyle(48, playType), 40, 11);
            MIDI.noteOff(0, playMIDIStyle(48, playType), 11.33);
            MIDI.noteOn(0, playMIDIStyle(48, playType), 40, 11.33);
            MIDI.noteOff(0, playMIDIStyle(48, playType), 11.66);
            MIDI.noteOn(0, playMIDIStyle(48, playType), 40, 11.66);
            MIDI.noteOff(0, playMIDIStyle(48, playType), 11.99);
            // Life is but a dream
            MIDI.noteOn(0, playMIDIStyle(55, playType), 40, 12);
            MIDI.noteOff(0, playMIDIStyle(55, playType), 12.75);
            MIDI.noteOn(0, playMIDIStyle(53, playType), 40, 12.75);
            MIDI.noteOff(0, playMIDIStyle(53, playType), 13);
            MIDI.noteOn(0, playMIDIStyle(52, playType), 40, 13);
            MIDI.noteOff(0, playMIDIStyle(52, playType), 13.5);
            MIDI.noteOn(0, playMIDIStyle(50, playType), 40, 13.75);
            MIDI.noteOff(0, playMIDIStyle(50, playType), 14);
            MIDI.noteOn(0, playMIDIStyle(48, playType), 40, 14);
            MIDI.noteOff(0, playMIDIStyle(48, playType), 15.5);
          }
        });
      };
    </script>
  </body>
</html>
